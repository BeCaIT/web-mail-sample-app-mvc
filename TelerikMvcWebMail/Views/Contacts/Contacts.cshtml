@using TelerikMvcWebMail.Models

@{
    ViewBag.Title = "Contacts";
}

@section PageStyles {
    <link href="@Url.Content("~/Content/contacts.css")" rel="stylesheet" type="text/css" />
}

<script type="text/x-kendo-tmpl" id="single-contact-template">
    <div class="contact-view k-widget" uid="#: uid #">
        <span class="hidden-email" style="display:none">#: Email #</span>
        <img src="@Url.Content("~/Content/contacts/")#:EmployeeID#.jpg" alt="#:EmployeeID # image" />
        <h3>#: Name #</h3>
        <div class="details">
            <p>Country : #: Country # </p>
            <p>City : #: City # </p>
            <p>Company : #: Company # </p>
            <p>Phone : #: HomePhone # </p>
        </div>
        <div class="edit-buttons">
            <a class="k-button k-single-email-button" href="\\#"><span class="k-icon k-i-maximize"></span></a>
            <a class="k-button k-single-edit-button" href="\\#"><span class="k-icon k-edit"></span></a>
            <a class="k-button k-single-delete-button" href="\\#"><span class="k-icon k-delete"></span></a>
        </div>
    </div>
</script>

<aside class="main-sidebar">
    <div class="content">
        @(Html.Kendo().Button()
        .Name("addNewContact")
        .Icon("plus")
        .Content("New Contact")
        .HtmlAttributes(new { type = "button" })
        .Events(ev => ev.Click("createNewContact"))
        )
        @(Html.Kendo().TreeView()
        .Name("contactsTreeView")
        .Events(e => e.Select("selectContactsFolder"))
        )
    </div>
    @Html.Partial("SidebarFooter")
</aside>

<div class="main-section">
    <div class="toolbar">
        <div class="left">
            <span class="btn btn-export-pdf" onclick="exportPeople()">Export to PDF</span>
        </div>
        <div class="right">
            <span class="btn btn-listdetails" onclick="changeToListDetails(this)" title="Display vertical panes"></span>
            <span class="btn btn-cards" onclick="changeToContactsCards(this)" title="Display cards"></span>
        </div>
    </div>
    <input type="text" class="k-input search-textbox" placeholder="Search people ...">
    <div class="contacts">
        @(Html.Kendo().ListView<TelerikMvcWebMail.Models.ContactViewModel>()
            .Name("contactsListView")
            .TagName("div")
            .ClientTemplateId("single-contact-template")
            .DataSource(dataSource => dataSource
                .Model(model => model.Id("EmployeeID"))
                .Create(create => create.Action("Contacts_Create", "Contacts"))
                .Read(read => read.Action("Contacts_Read", "Contacts"))
                .Update(update => update.Action("Contacts_Update", "Contacts"))
                .Destroy(destroy => destroy.Action("Contacts_Destroy", "Contacts"))
            )
            .Editable()
            .Selectable()
            .Events(e => e
                .DataBound("onListViewDataBound")
                .Change("onListViewSelectionChange")
            )
        )
        <div class="contact-details k-widget">
        </div>
    </div>
</div>

<script>
    var selectedContact = Cookies.get('selectedContact');
    var shouldChangeTreeViewNumbers = true;

    function setSelectedNode(selected) {
        var treeview = $("#contactsTreeView").data("kendoTreeView");
        if (selected) {
            Cookies.remove('selectedContact');
            var node = $("#contactsTreeView").find('li').eq(selected);
            treeview.select(node);
        }
    } 

    function exportPeople() {
        kendo.drawing.drawDOM($(".contacts"))
            .then(function (group) {
                return kendo.drawing.exportPDF(group, {
                    paperSize: "auto",
                    margin: { left: "1cm", top: "1cm", right: "1cm", bottom: "1cm" }
                });
            })
            .done(function (data) {
                kendo.saveAs({
                    dataURI: data,
                    fileName: "People.pdf"
                });
            });
    }

    function changeToListDetails(e) {
        var contactsElement = $('.contacts');
        contactsElement.removeClass("card-view");
        contactsElement.addClass("list-view");

        updateSelectedViewButton(e);
    }

    function changeToContactsCards(e) {
        var contactsElement = $('.contacts');
        contactsElement.removeClass("list-view");
        contactsElement.addClass("card-view");

        updateSelectedViewButton(e);
    }

    function updateSelectedViewButton(element) {
        var selectedClass = "selected";

        $(".toolbar ." + selectedClass).removeClass(selectedClass);
        $(element).addClass(selectedClass);
    }

    function getInitialNumberOfItems(listViewData) {
        var numbers = { Favorites: 0, Friends: 0, Work: 0 };
        for (var i = 0; i < listViewData.length; i++) {
            var currentItemCategory = listViewData[i].Folder;
            numbers[currentItemCategory] += 1;
        }

        numbers.All = numbers.Favorites + numbers.Friends + numbers.Work;

        return numbers;
    }

    function onListViewDataBound(e) {
        var listView = e.sender;
        var selectedItem = listView.select();

        if (selectedItem.length === 0) {
            listView.select(listView.element.children().first());
        }

        $.ajax({
            url: '@Url.Action("Contacts_Read", "Contacts")',
            success: function (listViewData) {
                var numbers = getInitialNumberOfItems(listViewData.Data);
                var data = [{
                    text: "All " + numbers.All,
                    value: "All"
                }, {
                    text: "Favorites " + numbers.Favorites,
                    value: "Favorites"
                }, {
                    text: "Friends " + numbers.Friends,
                    value: "Friends"
                }, {
                    text: "Work " + numbers.Work,
                    value: "Work"
                }];

                var newDataSource = new kendo.data.HierarchicalDataSource({ data: data });
                var navigationTreeView = $('#contactsTreeView').data('kendoTreeView');
                navigationTreeView.setDataSource(newDataSource);

                if (selectedContact) {
                    setSelectedNode(selectedContact);
                }
                else {
                    setSelectedNode("0");
                }
            }
        });

        $('.k-email-button').on('click', createNewMail);
        $('.search-textbox').on('keyup', searchContacts);
    }

    function selectContactsFolder(e) {
        debugger;
        var dataItem = e.sender.dataItem(e.node);
        var selectedText = dataItem.value;
        Cookies.set('selectedContact', kendo.stringify(dataItem.index));
        selectedContact = Cookies.get('selectedContact');

        var contactsListView = $("#contactsListView").data("kendoListView");

        if (selectedText === "All") {
            contactsListView.dataSource.filter({});
            shouldChangeTreeViewNumbers = true;
        } else {
            contactsListView.dataSource.filter({ field: "Folder", operator: "contains", value: selectedText });
            shouldChangeTreeViewNumbers = false;
        }
    }

    function searchContacts(e) {
        var text = $(e.target).val();

        var listView = $("#contactsListView").data("kendoListView");
        listView.dataSource.filter({ field: "Name", operator: "contains", value: text });
    }

    function createNewMail(e) {
        var target = $(e.target);
        var listVewItem = target.parents('.contact-list, .contact-card');
        var listView = $('#contactsListView').data('kendoListView');
        var dataItem = listView.dataItem(listVewItem);
        var email = dataItem.Email;

        debugger;

        $(".main-section").load('@(Url.Action("NewMail", "Home", new { @id = "placeholder0", @contact = "placeholder1"}))'.replace("placeholder0", '').replace("placeholder1", email));
        // Implement here create new email logic
    };

    function singleCreateNewMail(e) {
        var target = $(e.target);
        var singleItem = target.parents('.contact-view');
        var email = singleItem.find('.hidden-email').text();

        debugger;
        // Implement here create new email logic
    };

    function singleEditClick(e) {
        var uid = getItemUid(e);
        var listView = $("#contactsListView").data("kendoListView");
        listView.edit(listView.element.find('[data-uid="' + uid + '"]'));
    }

    function singleDeleteClick(e) {
        var uid = getItemUid(e);
        var listView = $("#contactsListView").data("kendoListView");
        listView.remove(listView.element.find('[data-uid="' + uid + '"]'));
    }

    function getItemUid(e) {
        var target = $(e.target);
        var singleItem = target.parents('.contact-view');
        return singleItem.attr('uid');
    }

    function onListViewSelectionChange(e) {
        var selecteditem = e.sender.select();
        var dataItem = e.sender.dataItem(selecteditem);
        var template = kendo.template($('#single-contact-template').html());
        var result = template(dataItem);
        $(".contact-details").html(result);

        $('.k-single-email-button').on('click', singleCreateNewMail);
        $('.k-single-edit-button').on('click', singleEditClick);
        $('.k-single-delete-button').on('click', singleDeleteClick);
    }

    function createNewContact() {
        var listView = $("#contactsListView").data("kendoListView");
        listView.add();
    }
</script>
