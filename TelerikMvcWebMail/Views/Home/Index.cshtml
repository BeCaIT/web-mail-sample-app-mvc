@{
    ViewBag.Title = "Mails";
}

@model IEnumerable<TelerikMvcWebMail.Models.MailViewModel>

<aside class="treeview-wrapper">
    <span class="add-new-mail" >New Mail</span>

    @(Html.Kendo().TreeView()
        .Name("mailsTreeView")
        .Events(e => e.Select("selectMailFolder"))
    )

    <div class="about-and-source">
        <div>
            @Html.ActionLink("About This App", "About", "Home")
        </div>
        <div>
            @Html.ActionLink("Download Source Code", "", "")
        </div>
        <p>
            Copyright &copy; @DateTime.Now.Year Progress Software Corporation and/or its subsidiaries or affiliates.
        </p>
        <p>
            All Rights Reserved.
        </p>
    </div>
</aside>

<div class="content">
    @(Html.Kendo().ToolBar()
        .Name("IndexToolbar")
        .Items(items =>
        {
            items.Add().Type(CommandType.SplitButton).Text("Reply").MenuButtons(menuButtons =>
            {
                menuButtons.Add().Text("Reply");
                menuButtons.Add().Text("Reply All");
                menuButtons.Add().Text("Forward");
            });

            items.Add().Type(CommandType.Button).Text("Delete").Click("toolBarButtonClick").Id("Deleted");

            items.Add().Type(CommandType.SplitButton).Click("toolBarButtonClick").Text("Move").MenuButtons(menuButtons =>
            {
                menuButtons.Add().Text("Inbox").Id("Inbox");
                menuButtons.Add().Text("Junk").Id("Junk");
                menuButtons.Add().Text("Drafts").Id("Drafts");
                menuButtons.Add().Text("Deleted").Id("Deleted");
            });

            items.Add().Type(CommandType.SplitButton).Text("Junk").MenuButtons(menuButtons =>
            {
                menuButtons.Add().Text("Report Spam");
            });

            items.Add().Type(CommandType.SplitButton).Text("More").MenuButtons(menuButtons =>
            {
                menuButtons.Add().Text("Reply").Url("/Home/NewMail");
                menuButtons.Add().Text("Reply All").Url("/Home/NewMail");
                menuButtons.Add().Text("Forward").Url("/Home/NewMail");
            });

            items.Add().Type(CommandType.Button).SpriteCssClass("k-tool-icon k-justifyLeft").Click("changeToVerticalPanes");
            items.Add().Type(CommandType.Button).SpriteCssClass("k-tool-icon k-justifyRight").Click("changeToHorizontalPanes");
        })
    )
    <div class="inner-mail-content">
        <div class="mail-grid">
            @(Html.Kendo().Grid(Model)
				.Name("MailGrid")
				.Columns(columns =>
				{
					columns.Bound(p => p.CheckBoxCheked)
						.Title("")
						.Width(80)
						.ClientTemplate("<input type='checkbox' #= CheckBoxCheked ? checked='checked': '' # class='chkbx' />");
					columns.Bound(p => p.From).Title("From").Width(300);
					columns.Bound(p => p.Subject).Title("Subject");
					columns.Bound(p => p.Date).Title("Date").Width(300).Format("{0:g}");
				})
				.HtmlAttributes(new { style = "height: 100%;" })
				.Sortable()
				.Scrollable()
				.Filterable()
				.Groupable()
				.Selectable(s => s.Mode(GridSelectionMode.Multiple))
				.DataSource(dataSource => dataSource
					.Ajax()
					.AutoSync(true)
					.PageSize(20)
					.Model(model => model.Id(p => p.MailID))
					.Create(create => create.Action("Create", "Home"))
					.Read(read => read.Action("Read", "Home"))
					.Update(update => update.Action("Update", "Home"))
					
				)
				.Events(e => e.Change("mailSelectionChanged").DataBound("mailGridDataBound"))
            )
        </div>
        <div class="mail-details">
            <div class="mail-details-header">
                <p class="mail-subject"></p>
                <p class="mail-sender"></p>
                <p class="mail-date"></p>
            </div>
            <p class="mail-text"></p>
        </div>
    </div>
</div>
<script>
    var selected = Cookies.get('selected');

    function setSelectedNode(selected) {
        var treeview = $("#mailsTreeView").data("kendoTreeView");
        if (selected) {
            Cookies.remove('selected');
            var node = $("#mailsTreeView").find('li').eq(selected);
            treeview.select(node);
        }
    }

    function toolBarButtonClick(e) {
        var grid = $("#MailGrid").data("kendoGrid");
        var selectedItem = grid.dataItem(grid.select());

        if (selectedItem) {
            selectedItem.Folder = e.id;
            selectedItem.dirty = true;

            grid.dataSource.sync();

            var treeview = $("#mailsTreeView").data("kendoTreeView");
            var dataItem = treeview.dataItem(treeview.select());

            if (dataItem) {
                grid.dataSource.filter({ field: "Folder", operator: "contains", value: dataItem.value });
            }

            //grid.refresh();
        }
    }

    function changeToVerticalPanes() {
        $('.mail-grid').attr('style', "display: inline-block; width: 35%");
        $('.mail-details').attr('style', "display: inline-block; vertical-align: top;");
    }

    function changeToHorizontalPanes() {
        $('.mail-grid').attr('style', "display: block;");
        $('.mail-details').attr('style', "display: block;");
    }

    function selectMailFolder(e) {
        var dataItem = this.dataItem(e.node);
        var selectedText = e.sender.dataItem(e.node).value;
        Cookies.set('selected', kendo.stringify(dataItem.index));
        selected = Cookies.get('selected');

        var mailsGrid = $("#MailGrid").data("kendoGrid");
        if (!mailsGrid) {
            window.location.href = "/Home/Index";
        } else {
            mailsGrid.dataSource.filter({ field: "Folder", operator: "contains", value: selectedText });
        }
    }

    function getinitialNumberOfItems(gridData) {
        var numbers = { Inbox: 0, Junk: 0, Drafts: 0, Deleted: 0, NativeScript: 0, KendoUI: 0, Sitefinity: 0 };
        for (var i = 0; i < gridData.length; i++) {
            var currentItemFolder = gridData[i].Folder;
            numbers[currentItemFolder] += 1;
        }

        return numbers;
    }

    function mailGridDataBound(e) {
        var navigationTreeView = $('#mailsTreeView').data('kendoTreeView');

        $.ajax({
            url: '@Url.Action("Read", "Home")',
            success: function (gridData) {
                var numbers = getinitialNumberOfItems(gridData.Data);
                var data = [{
                    text: "Inbox " + numbers.Inbox,
                    value: "Inbox"
                }, {
                    text: "Junk " + numbers.Junk,
                    value: "Junk"
                }, {
                    text: "Drafts " + numbers.Drafts,
                    value: "Drafts"
                }, {
                    text: "Deleted " + numbers.Deleted,
                    value: "Deleted"
                }, {
                    text: "NativeScript " + numbers.NativeScript,
                    value: "NativeScript"
                }, {
                    text: "KendoUI " + numbers.KendoUI,
                    value: "KendoUI"
                }, {
                    text: "Sitefinity " + numbers.Sitefinity,
                    value: "Sitefinity"
                }];

                var newDataSource = new kendo.data.HierarchicalDataSource({ data: data });
                navigationTreeView.setDataSource(newDataSource);

                if (selected) {
                    setSelectedNode(selected);
                }
            }
        });
    }

    function mailSelectionChanged(e) {
        var selectedRows = this.select();
        $('input.chkbx').prop('checked', false);
        
        var checkboxes = selectedRows.find('.chkbx');
        checkboxes.prop('checked', true);
    }

    $('.add-new-mail').on('click', function (e) {
        $(".content").load('@(Url.Action("NewMail", "Home"))');
    });
</script>
